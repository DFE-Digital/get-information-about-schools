<?xml version="1.0" encoding="utf-8"?>
<!--
  Do not edit connection string / app settings in this file directly.
  ===================================================================
  Instead, to specify custom values for configuration options / connection strings:
  - On Azure: specify application configuration options
  - Locally:  update your local config file / secrets
-->
<configuration>
  <connectionStrings>
    <!--
      Connection string to the GIAS website's Azure Storage account
      - Table storage
      - Blob storage

      Note that the API typically uses a different Azure Storage account
      to serve e.g., pre-generated extracts/downloads.
    -->
    <add name="DataConnectionString" connectionString="" />
    <!--
      The GIAS website makes (limited) use of Redis caches to minimise the number of API requests made.
      This is in combination with a variety of in-memory caches.

      GIAS's caching strategy is for review, and this may be removed at a later date.
    -->
    <add name="Redis" connectionString="" />
  </connectionStrings>
  <appSettings>
    <!-- ==== SERVER / WEBSITE CONFIGURATION ==== -->
    <!--
      The 'Environment` setting is used as a descriptor for the environment in which the application is running.
      - When running locally, this value should be set to 'localdev' (some local-specific options rely on this).
    -->
    <add key="Environment" value="localdev" />
    <!--
      TBC, Potentially unused, replaced by filter and `EnableFriendlyErrorPage`(?)
      See also: Edubase.Web.UI.MvcApplication.Application_Error
    -->
    <add key="EnableErrorReporting" value="true" />
    <!--
      A "friendly" error page is one which hides the technical detail / stack trace.

      By default this is `true` as stack traces and other technical detail are not appropriate
      to include within user-facing errors, however overriding this within local/dev environments
      for debugging/testing purposes is likely desirable.

      See also: Edubase.Web.UI.Filters.ExceptionHandler.OnException
    -->
    <add key="EnableFriendlyErrorPage" value="true" />
    <!--
      Razor engine version (e.g., MVC3 users Razor v3)

      See also: https://devblogs.microsoft.com/dotnet/how-does-vs-determine-which-version-of-razor-engine-to-use-when-editing-razor-webpage-files.aspx
    -->
    <!--
      Setting `webpages:Enabled` to `false` prevents direct access of e.g., `.cshtml` files
    -->
    <!--
      Where GIAS is accessed via a proxy (e.g., Azure Front Door), the header `X-Forwarded-Host`
      may be used to determine the user-facing hostname (e.g., as displayed in the browser).

      - This value may be set/overridden manually by users, therefore must not be trusted.

      - If a direct request is received (i.e., no `X-Forwarded-Host` header), the
        value of `AllowedForwardedHostNames` is ignored/not used as there will be
        no forwarded header to validate.

      Values for `AllowedForwardedHostNames` may be:
      - A single host (e.g., `example.com`).
        - The value must be acceptable by `System.UriBuilder.Host` as a valid host name.
        - An empty (or trimmable-whitespace-only) value is treated as no value.
        - Where a `x-forwarded-host` header is supplied within the request, it must match this value.
      - A comma-separated list of permitted hosts.
        - As per the single value, but allows for e.g., the `www.` variant of a domain/sub-domain.
        - Empty (or trimmable-whitespace-only) values are removed from the collection of values.
        - Where a `x-forwarded-host` header is supplied within the request, it must match one of these values.
      - Not specified, or where all values are trimmable to be empty (e.g., ` ` or `  ,  ,,, `).
        - Empty values are removed from the list and whatever remains will be treated as either no value, .

      See also: Edubase.Web.UI.Helpers.UrlHelperExtensions.GetForwardedHeaderAwareUrl
    -->
    <!-- <add key="AllowedForwardedHostNames" value="example.com"/> -->
    <!-- <add key="AllowedForwardedHostNames" value="example.com,www.example.com"/> -->
    <!--
      Where GIAS is accessed via a proxy (e.g., Azure Front Door / WAF):
      - The source IP passed via the (custom) `x-source-ip` header to the API
        is the proxy's IP address, not the user's IP address.
      - Rate limting of requests to the API is based on this source IP address,
        therefore all users accessing via the proxy will be subject to the same rate limit.

      As documented within HttpClientWrapper.cs, making GIAS take into account
      the `x-forwarded-for` header (similar to `x-forwarded-host`) was considered
      as part of #189483 but the effort to do this correctly (and securely) was
      deemed too high for the benefit (in the same way that we define the configuration
      option `AllowedForwardedHostNames` for forwarded host values, a simliar list
      of known forwarded internal/Azure IP addresses would be required and maintained).

      Note that the `x-forwarded-for` header may be spoofed by users, therefore must not be trusted.
      (e.g., a user could edit the header with a different value to bypass rate limiting)

      Where a WAF is in place (and providing upstream rate-limiting), this configuration
      may be used to instruct the API to not rate limit any of these requests as they
      are originating from the GIAS website (n.b.: the only permitted client for the API).

      Values for `xSourceIpOverride` may be:
      - Not provided  / an empty string (after trimming) is equivalent to disabling this override
      - A single IP address (e.g., `192.168.0.1` or any other valid IPv4 address)
      - An arbitrary string
        - (max 40 chars per database column width restriction - excess characters are truncated)
        - Note that the backend API has an option to validate this value.
        - If wanting to provide a value which does not conform to IPv4 syntax, this validation must be disabled.

      If not provided, or is empty after trimming whitespace, this is treated as not provided and behaviour should
      continue as previously defined using the client IP address passed to the website.
    -->
    <add key="xSourceIpOverride" value="" />
    <!-- ==== GIAS WEBSITE DEBUGGING ==== -->
    <!--
      TBC - Used by Glimpse? (debugging tool)
    -->
    <add key="ApiTraceSessionRetentionCount" value="25" />
    <!--
      Debugging utility to inspect routes available and routes potentially matching the current page

      This is disabled by default (`false`), though enabling it (`true`) locally for debug/test purposes may be desirable.

      See also: https://haacked.com/archive/2008/03/13/url-routing-debugger.aspx/
    -->
    <add key="RouteDebugger:Enabled" value="false" />
    <!--
      API Logging records the HTTP requests and responses made to the API.
      If enabled, these logs are placed within Azure Table Storage.
      These logs are associated with
      - the `SaUserId` for logged in users, or
      - the cookie value of `ApiSessionId` for not-logged-in users

      WARNING: These logs are highly detailed and contain sensitive data
      (e.g., HTTP headers, including authorisation headers), therefore
      must not routinely be enabled in production.

      If this is enabled in production-like environment, access to the log data
      *must* be monitored, and the data must be removed as soon as reasonably practical.
    -->
    <add key="EnableApiLogging" value="false" />
    <!-- ==== GIAS WEBSITE FUNCTIONALITY CONFIGURATION ==== -->
    <!--
      This is the maximum permitted age (in days) of a data quality check,
      before users will be prompted again.
    -->
    <add key="DataQualityUpdatePeriod" value="7" />
    <!--
      Sitemaps are accessed by e.g., search engine bots to index the website.
      - `SitemapCacheDays`      The maximum age of a generated and cached (in-memory) sitemap file (days)
      - `SitemapExcludeApi`     Misleadingly named - API routes (used by JavaScript) will be
                                - excluded from the sitemap where this value is set to value `0` (a normally falsey value), and
                                - included in the sitemap when value is set to `1` (or any other non-zero int, a normally truthy value)

      See also: Edubase.Web.UI.Controllers.SitemapController.ExcludeApiLookup
    -->
    <add key="SitemapCacheDays" value="21" />
    <add key="SitemapExcludeApi" value="0" />
    <!-- ====  ==== -->
    <add key="Content-Security-Policy" value="base-uri 'self'; object-src 'none'; default-src 'self'; frame-ancestors 'none'; connect-src 'self' https://*.google-analytics.com https://*.analytics.google.com https://www.find-school-performance-data.service.gov.uk/ https://*.clarity.ms; frame-src https://www.googletagmanager.com; img-src 'self' data: https://*.google-analytics.com https://*.analytics.google.com https://atlas.microsoft.com https://*.clarity.ms; style-src 'self' 'unsafe-inline'; font-src 'self' data:; script-src 'self' 'nonce-inject' 'unsafe-eval' https://www.googletagmanager.com https://*.google-analytics.com https://*.analytics.google.com https://code.jquery.com http://d3js.org https://*.clarity.ms;" />
    <!-- ==== JAVASCRIPT API KEYS ==== -->
    <!--
      API Keys
      - `GoogleApiKeyClientSide`    Analytics of access to the GIAS website (details TBC)
      - `GoogleTagManagerKey`       Analytics of access to the GIAS website (details TBC)
      - `AzureMapsApiKey`           Maps are displayed on the search results and some establishment detail pages
      - `OSPlacesApiKey`            Auto-complete functionality on Azure Maps (TBC)
      - `ClarityKey`                User behaviour tracking and insights to improve website experience
    -->
    <add key="GoogleApiKeyClientSide" value="" />
    <add key="GoogleTagManagerKey" value="" />
    <add key="AzureMapsApiKey" value="" />
    <add key="OSPlacesApiKey" value="" />
    <add key="ClarityKey" value="" />
    <!-- TBC -->
    <!-- TBC -->
    <!-- ==== GIAS API DEPENDENCIES ==== -->
    <!--
      Data presented via the GIAS website and changes made by GIAS website users is normally
      provided by the backend API.
      Note: Do not supply username/password (or other secrets) directly here.
      Specify this via app config on Azure, or via dev secrets if running locally.
    -->
    <add key="TexunaApiBaseAddress" value="" />
    <add key="api:Username" value="rest-api-user" />
    <add key="api:Password" value="" />
    <add key="LookupApiBaseAddress" value="" />
    <add key="LookupApiUsername" value="rest-api-user" />
    <add key="LookupApiPassword" value="" />
    <add key="GovernorSearchApiBaseAddress" value="" />
    <add key="GovernorSearchApiUsername" value="rest-api-user" />
    <add key="GovernorSearchApiPassword" value="" />
    <!-- ==== 3RD PARTY API DEPENDENCIES ==== -->
    <!--
      Academies are registered businesses, and some information about those businesses are made visible within GIAS.
      Companies House supply those business/company details via the API.
    -->
    <add key="CompaniesHouseBaseUrl" value="https://beta.companieshouse.gov.uk/company/" />
    <add key="CompaniesHouseApiKey" value="" />
    <!--
      The Schools Financial Benchmarking (SFB) service provides data
      about education establishments and Academy Trusts.

      Where a SFB record exists for an establishment/academy trust, GIAS provides a link to that page.

      This configuration defines the website where the link points at, and for how long
      GIAS should cache the check to see if SFB contains data about that establishment.

      - `FinancialBenchmarkingURL`            URL linked to from the GIAS home page
      - `FinancialBenchmarkingApiURL`         Base URL linked to from establishment/MAT details pages
      - `FinancialBenchmarkingCacheHours`     GIAS only shows the establishment/MAT-specific link if GIAS has been able to
                                              confirm that the associated FSCPD page exists.
                                              This setting configures the maximum age of the check result.
      - `FinancialBenchmarkingUsername`       (Not normally supplied) Basic auth username to access the FSB service.
      - `FinancialBenchmarkingPassword`       (Not normally supplied) Basic auth username to access the FSB service.

      See also: https://schools-financial-benchmarking.service.gov.uk/
    -->
    <add key="FinancialBenchmarkingURL" value="https://schools-financial-benchmarking.service.gov.uk/" />
    <add key="FinancialBenchmarkingApiURL" value="https://api.schools-financial-benchmarking.service.gov.uk/" />
    <add key="FinancialBenchmarkingCacheHours" value="72" />
    <add key="FinancialBenchmarkingUsername" value="" />
    <add key="FinancialBenchmarkingPassword" value="" />
    <!--
      The Find School and College Performance Data (FSCPD) service provides data
      about education establishments and Multi-Academy Trusts (MATs).

      Where a FSCPD record exists for an establishment, GIAS provides a link to that page.
      This configuration defines the website where the link points at, and for how long
      GIAS should cache the check to see if FSCPD contains data about that establishment.

      See also: https://www.gov.uk/school-performance-tables
      See also: https://www.find-school-performance-data.service.gov.uk

      - `FscpdHomeUrl`      URL linked to from the GIAS home page
      - `FscpdURL`          Base URL linked to from establishment/MAT details pages
      - `FscpdServiceName`  Name of the service to use within links (set via configuration as this has changed several times)
      - `FscpdCacheHours`   GIAS only shows the establishment/MAT-specific link if GIAS has been able to
                            confirm that the associated FSCPD page exists.
                            This setting configures the maximum age of the check result.
      - `FscpdUsername`     (Not normally supplied) Basic auth username to access the FSCPD service.
      - `FscpdPassword`     (Not normally supplied) Basic auth username to access the FSCPD service.
    -->
    <add key="FscpdHomeUrl" value="https://www.gov.uk/school-performance-tables" />
    <add key="FscpdURL" value="https://www.compare-school-performance.service.gov.uk/" />
    <add key="FscpdServiceName" value="Compare school and college performance in England" />
    <add key="FscpdCacheHours" value="72" />
    <add key="FscpdUsername" value="" />
    <add key="FscpdPassword" value="" />
    <!--
      Ofsted provide reports on education establishments, and GIAS provides links to those reports.
      Note: Since #232199, GIAS will not display the ratings directly (due to changes in ratings - no longer a single overall rating available),
      but will link to the Ofsted website (where a page on the Ofsted website for this URN exists).

      Configuration options:
      - `OfstedService_BaseAddress`     The base URL to link from, where it is expected that the URN will be appended.
      - `OfstedService_CacheHours`      How long GIAS should cache the check to see if Ofsted has a page for that URN.
      - `OfstedService_TimeoutSeconds`  How long GIAS should wait for a response from the Ofsted service.
      - `OfstedService_RetryIntervals`  Retry intervals, used by Polly for retrying requests to the Ofsted service.
      - `OfstedService_Username`        If the Ofsted service (per base URL) requires Basic Auth, this is the username.
      - `OfstedService_Password`        If the Ofsted service (per base URL) requires Basic Auth, this is the password.
    -->
    <add key="OfstedService_BaseAddress" value="http://www.ofsted.gov.uk/oxedu_providers/full/(urn)/" />
    <add key="OfstedService_CacheHours" value="72" />
    <add key="OfstedService_TimeoutSeconds" value="5" />
    <add key="OfstedService_RetryIntervals" value="1" />
    <add key="OfstedService_Username" value="" />
    <add key="OfstedService_Password" value="" />
    <!-- #232199: Feature flag, to optionally hide/display the Ofsted ratings -->
    <add key="Feature_Ofsted_ShowRatings" value="false" />
    <!-- 
      #232199 / #232608: Feature flag, to optionally hide/display the Ofsted fields in the bulk update guidance.
      - A value of `true` will display the Ofsted fields within the bulk update guidance
      - Any other value will hide them.
    -->
    <add key="Feature_Ofsted_ShowBulkUpdateGuidance" value="false" />
    <add key="OSPlacesUrl" value="https://api.os.uk/" />
    <add key="AzureMapsUrl" value="https://atlas.microsoft.com" />
    <!-- ==== WEBSITE AUTHENTICATION / AUTHORISATION ==== -->
    <!--
      ACCESS TO THE SERVER THAT GIAS IS HOSTED UPON

      Non-Production and non-local instances of the Web UI should not be openly visible to the world.
      - `HttpAuthModule.AuthMode`      Value of `Basic` enables use of "Basic authorisation" username/password access
      - `HttpAuthModule.Credentials`   Value in format of `username:password` (with an Auth Mode of `Basic`)

      See also: the <httpAuthModule> section below, within the file `Web.config`.
  -->
    <add key="HttpAuthModuleEnabled" value="true" />
    <add key="HttpAuthModule.AuthMode" value="Basic" />
    <add key="HttpAuthModule.Realm" value="Edubase" />
    <!-- <add key="HttpAuthModule.Credentials" value="" /> -->
    <add key="HttpAuthModule.IgnoreIPAddresses" value="127.0.0.1;::1" />
    <!-- TIMEOUT SETTINGS -->
    <add key="FBService_Timeout" value="2" />
    <add key="FBService_RetryIntervals" value="1" />
    <add key="HttpClient_Timeout" value="30" />
    <add key="LookupClient_Timeout" value="10" />
    <!-- Governor search currently performs extremely poorly, therefore increase timeout specifically for this to accommodate -->
    <add key="GovernorSearchClient_Timeout" value="45" />
    <add key="FscpdClient_Timeout" value="2" />
    <add key="FscpdClient_RetryIntervals" value="1" />
    <add key="AzureMapService_Timeout" value="2" />
    <add key="AzureMapService_RetryIntervals" value="1,2,2,4" />
    <add key="OSPlacesApiServices_Timeout" value="10" />
    <add key="OSPlacesApiServices_RetryIntervals" value="1,2,2,4" />
    <!--
      ACCESS TO INTERACT WITH DATA HELD BY GIAS

      Logging in to the GIAS website and the API is via data/claims sourced from a SAML(?) provider.
      - Currently this is DfE Sign In (DSI), though a DSI Simulator
      - Previous incarnations of GIAS include "Secure Access" (SA), whose legacy initials are
        refrenced by some variable names e.g., "SA User ID" and `SA Simulator`

      Toggling between options is specified via `owin:appStartup` (configurations for each are below)
      - `SecureAccessConfiguration`   Use of DSI
      - `SASimulatorConfiguration`    Use of the DSI Simualator
    -->
    <add key="owin:appStartup" value="SASimulatorConfiguration" />
    <!--
      SA/DSI configuration
      - `ApplicationIdpEntityId`          The Entity ID of the SAML(?) provider.
      - `ExternalAuthDefaultCallbackUrl`  The URL the Identity Provider (IDP) will redirect to after a successful login,
                                            where the token will be recieved and processed by the GIAS website.
      - `MetadataLocation`                The URL to the Identity Provider (IDP) metadata file.
      - `SessionExpireTimeSpan`           The duration (hh:MM:ss) for which the session cookie remains valid,
                                            - specifically the `Expires/Max-Age` field on the cookie.
                                            - See also: Edubase.Web.UI.StartupSecureAccess.ConfigureAuth
      - `PublicOrigin`                    The URL of the GIAS website, as seen by the Identity Provider (IDP).
                                          This may be required if the GIAS website is hosted behind a proxy/WAF.
                                          Omitting this setting will default to using the value provided by `request.ApplicationUrl`.
                                          See also #157607 and #171878.
    -->
    <add key="ApplicationIdpEntityId" value="https://stg.education.gov.uk/edubase" />
    <add key="ExternalAuthDefaultCallbackUrl" value="http://localhost:51350/Account/ExternalLoginCallback" />
    <add key="MetadataLocation" value="https://pp-gias.signin.education.gov.uk/saml/metadata" />
    <add key="SessionExpireTimeSpan" value="00:59:00" />
    <!-- <add key="PublicOrigin" value="" /> -->
    <!--
      SA/DSI Simulator configuration
      - `SASimulatorUri`   the base URL for the instance of the SA/DSI Simulator
      - `SASimulatorGuid`  the GUID for "your application's" simulator configuration (pre-configured users)

      Notes:
      - The simulator URL will be `{SASimulatorUri}{SASimulatorGuid}?{lots of SAML request bits}`
        - e.g., https://dfe-sign-in-simulator.azurewebsites.net/{GUID-123-abc}/?SAMLRequest=
      - It can be managed via the url `{SASimulatorUri}{SASimulatorGuid}/Manage`
        - e.g., https://dfe-sign-in-simulator.azurewebsites.net/{GUID-123-abc}/Manage
    -->
    <add key="SASimulatorUri" value="https://dfe-sign-in-simulator.azurewebsites.net/" />
    <add key="SASimulatorGuid" value="" />
    <!--
      NotificationBannerCacheExpirationInMinutes sets how long before the cache for notification banners expires
      The cache is used to reduce how often the table storage is hit
      As each request requires a load of the notifiaction banners
    -->
    <add key="NotificationBannerCacheExpirationInSeconds" value="300" />
  </appSettings>
  <!--<system.net>
    <defaultProxy>
      <proxy bypassonlocal="False" usesystemdefault="True" proxyaddress="http://127.0.0.1:8888" />
    </defaultProxy>
  </system.net>-->
  <!--
  For a description of web.config changes see http://go.microsoft.com/fwlink/?LinkId=235367.

  The following attributes can be set on the <httpRuntime> tag.
    <system.Web>
      <httpRuntime targetFramework="4.7.2" />
    </system.Web>
-->
</configuration>