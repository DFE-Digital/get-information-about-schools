# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
- dev

pool:
  name: DM Build
  demands:
  - DotNetFramework
  - msbuild
  - visualstudio
  - vstest

#Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971

steps:
- task: PowerShell@1
  displayName: 'Version assemblies'
  inputs:
    scriptName: ApplyVersionToAssemblies.ps1

- task: NuGetToolInstaller@1
  displayName: 'Use NuGet 5.x'
  inputs:
    versionSpec: 5.x
    checkLatest: true

- task: NuGetCommand@2
  displayName: 'NuGet restore'
  inputs:
    vstsFeed: 'a6f46800-edce-47b5-9e24-f76f1989899c'

- task: NodeTool@0
  displayName: 'Use Node 14.x'
  inputs:
    versionSpec: 14.x

- task: Npm@1
  displayName: 'npm install'
  inputs:
    workingDir: Web/Edubase.Web.UI
    verbose: false

- task: CmdLine@1
  displayName: 'Compile sass/js'
  inputs:
    filename: 'unit-tests.cmd'
    workingFolder: Web/Edubase.Web.UI/ci

- task: VSBuild@1
  displayName: 'Build solution **\*.sln'
  inputs:
    msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\" /p:PrecompileBeforePublish=true /p:UseMerge=true /p:SingleAssemblyName=AppCode /p:RunCodeAnalysis=true'
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

- task: VSTest@2
  displayName: 'Run Unit Tests with Code Coverage'
  inputs:
    testAssemblyVer2: |
     **\*unittest*.dll
     !**\obj\**
    codeCoverageEnabled: true
    diagnosticsEnabled: True

- task: AzureRmWebAppDeployment@3
  displayName: 'Azure App Service Deploy: gias-dev'
  inputs:
    azureSubscription: 'rg-t1dv-gias'
    WebAppName: gias
    DeployToSlotFlag: true
    ResourceGroupName: 'rg-t1dv-gias'
    SlotName: dev
    Package: '$(build.artifactstagingdirectory)/**/Edubase.Web.UI.zip'
    UseWebDeploy: true
    RemoveAdditionalFilesFlag: true
