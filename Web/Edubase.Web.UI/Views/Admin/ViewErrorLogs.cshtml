@using Edubase.Data.Entity
@{
    ViewBag.Title = "View error logs";
    ViewBag.bodyClasses = "view-error-logs";
    ViewBag.SiteSection = "tools";

    var messages = ViewBag.Messages as List<AZTLoggerMessages> ?? throw new Exception("Expected AZTLoggerMessages list in ViewBag.Messages");
    messages = messages.OrderByDescending(m => m.Timestamp).ToList();

    var referenceDate = ViewBag.ReferenceDate;
    var days = ViewBag.Days;
    var includePurgeZeroLogsMessage = ViewBag.IncludePurgeZeroLogsMessage;
}

@section BreadCrumbs
{
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <div class="govuk-breadcrumbs">
                <ol class="govuk-breadcrumbs__list">
                    <li class="govuk-breadcrumbs__list-item">
                        @Html.ActionLink("Home", "Index", "Home", new { area = "" }, new { @class = "govuk-breadcrumbs__link" })
                    </li>
                    <li class="govuk-breadcrumbs__list-item">
                        @Html.ActionLink("Tools", "Index", "Tools", new { area = "" }, new { @class = "govuk-breadcrumbs__link" })
                    </li>
                    <li id="tertiary-breadcrumb" class="govuk-breadcrumbs__list-item hidden">
                        @Html.ActionLink("View error logs", "ViewErrorLogs", "Admin", new { area = "" }, new { @class = "govuk-breadcrumbs__link" })
                    </li>
                </ol>
            </div>
        </div>
    </div>
}

<div class="govuk-grid-row">
<div class="govuk-grid-column-full">
<h1 class="govuk-heading-xl">Errors</h1>

<p class="govuk-body">
    This page shows the most recent messages that have been logged by the C# frontend.
    The vast bulk of these are generated by the "Sorry, there is a problem with the service" page, where the user is also shown a reference ID.
</p>
<p class="govuk-body">
    If you need to investigate further, or if you need to query the logs of any other component (e.g., the Java backend), please contact the technical team.
</p>

<ul>
    <li>Reference date: @referenceDate</li>
    <li>Days: @days</li>
    <li>Include empty puge logs: @includePurgeZeroLogsMessage</li>
    <li>Results count: @messages.Count()</li>
</ul>

@* show table of results *@

@* <div class="govuk-grid-row"> *@
@*     <div class="govuk-grid-column-full"> *@
@*         <table class="govuk-table govuk-table--small-text-until-tablet"> *@
@*             <thead class="govuk-table__head"> *@
@*             <tr class="govuk-table__row"> *@
@*                 <th scope="col" class="govuk-table__header">Date</th> *@
@*                 <th scope="col" class="govuk-table__header">Level</th> *@
@*                 <th scope="col" class="govuk-table__header">Message</th> *@
@*                 <th scope="col" class="govuk-table__header">URL</th> *@
@*                 <th scope="col" class="govuk-table__header">Referrer URL</th> *@
@*                 <th scope="col" class="govuk-table__header">HTTP Method</th> *@
@*                 <th scope="col" class="govuk-table__header">Request JSON Body</th> *@
@*                 <th scope="col" class="govuk-table__header">User Agent</th> *@
@*                 <th scope="col" class="govuk-table__header">User ID</th> *@
@*                 <th scope="col" class="govuk-table__header">Username</th> *@
@*                 <th scope="col" class="govuk-table__header">Environment</th> *@
@*                 <th scope="col" class="govuk-table__header">Client IP Address</th> *@
@*                 <th scope="col" class="govuk-table__header">Exception</th> *@
@* *@
@*             </tr> *@
@*             </thead> *@
@*             <tbody class="govuk-table__body"> *@
@*             @foreach (var message in messages) *@
@*             { *@
@*                 <tr class="govuk-table__row"> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.Timestamp</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.Level</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.Message</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;"> *@
@*                         <a href="@message.Url"> *@
@*                         @message.Url *@
@*                         </a> *@
@*                     </td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.ReferrerUrl</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.HttpMethod</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;"> *@
@*                         @if (!string.IsNullOrWhiteSpace(message.RequestJsonBody)) *@
@*                         { *@
@*                             <textarea rows="8">@message.RequestJsonBody</textarea> *@
@*                         } *@
@*                     </td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.UserAgent</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.UserId</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.UserName</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.Environment</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;">@message.ClientIpAddress</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 5em; overflow: auto;"> *@
@*                         <textarea rows="4">@message.Exception</textarea> *@
@*                     </td> *@
@* *@
@*                 </tr> *@
@*             } *@
@*             </tbody> *@
@*         </table> *@
@*     </div> *@
@* </div> *@



@* <div class="govuk-grid-row"> *@
@*     <div class="govuk-grid-column-full"> *@
@*         <table class="govuk-table govuk-table--small-text-until-tablet"> *@
@*             <thead class="govuk-table__head"> *@
@*             <tr class="govuk-table__row"> *@
@*                 <th scope="col" class="govuk-table__header">Date</th> *@
@*                 <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Message</th> *@
@*                 <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Request</th> *@
@*                 <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">User</th> *@
@*                 <th scope="col" class="govuk-table__header">Exception</th> *@
@* *@
@*             </tr> *@
@*             </thead> *@
@*             <tbody class="govuk-table__body"> *@
@*             @foreach (var message in messages) *@
@*             { *@
@*                 <tr class="govuk-table__row"> *@
@*                     <td class="govuk-table__cell" style="overflow: auto;">@message.Timestamp</td> *@
@*                     <td class="govuk-table__cell" style="max-width: 7.5em; overflow: auto;"> *@
@*                         @message.Id<br/> *@
@*                         @message.Message *@
@*                     </td> *@
@*                     <td class="govuk-table__cell" style="overflow: auto;"> *@
@*                         <dl class="govuk-summary-list"> *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">HTTP Method</dt> *@
@*                                 <dd class="govuk-summary-list__value">@message.HttpMethod</dd> *@
@*                             </div> *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">URL</dt> *@
@*                                 <dd class="govuk-summary-list__value"> *@
@*                                     <a href="@message.Url"> @message.Url</a> *@
@*                                 </dd> *@
@*                             </div> *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">Referrer URL</dt> *@
@*                                 <dd class="govuk-summary-list__value">@message.ReferrerUrl</dd> *@
@*                             </div> *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">User Agent</dt> *@
@*                                 <dd class="govuk-summary-list__value">@message.UserAgent</dd> *@
@*                             </div> *@
@* *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">Request Body</dt> *@
@*                                 <dd class="govuk-summary-list__value">@if (!string.IsNullOrWhiteSpace(message.RequestJsonBody)) *@
@*                                     { *@
@*                                     <textarea rows="8">@message.RequestJsonBody</textarea> *@
@*                                     }</dd> *@
@*                             </div> *@
@* *@
@*                         </dl> *@
@*                     </td> *@
@*                     <td class="govuk-table__cell" style="overflow: auto;"> *@
@*                         <dl class="govuk-summary-list"> *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">User ID</dt> *@
@*                                 <dd class="govuk-summary-list__value">@message.UserId</dd> *@
@*                             </div> *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">Username</dt> *@
@*                                 <dd class="govuk-summary-list__value">@message.UserName</dd> *@
@*                             </div> *@
@* *@
@*                             <div class="govuk-summary-list__row"> *@
@*                                 <dt class="govuk-summary-list__key">Client IP Address</dt> *@
@*                                 <dd class="govuk-summary-list__value">@message.ClientIpAddress</dd> *@
@*                             </div> *@
@*                         </dl> *@
@*                     </td> *@
@*                     <td class="govuk-table__cell" style="overflow: auto;"> *@
@*                         <textarea rows="4">@message.Exception</textarea> *@
@*                     </td> *@
@* *@
@*                 </tr> *@
@*             } *@
@*             </tbody> *@
@*         </table> *@
@*     </div> *@
@* </div> *@


<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <table class="govuk-table govuk-table--small-text-until-tablet">
            <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Timestamp</th>
                <th scope="col" class="govuk-table__header">Message</th>
                @* <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Request</th> *@

            </tr>
            </thead>
            <tbody class="govuk-table__body">
            @foreach (var message in messages)
            {
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell" style="overflow: auto;">@message.Timestamp</td>
                    <td class="govuk-table__cell" style="max-width: 7.5em; overflow: auto;">
                        <div class="govuk-inset-text">
                        Reference: <strong class="govuk-tag govuk-tag--grey">@message.Id</strong>
                        <br/>
                        <a href="@message.Url">@message.Url</a>
                        </div>
                        @* <br/> *@
                        @* <br/> *@
                            @message.Message
                        <br/>
                        <br/>
                        <details class="govuk-details">
                            <summary class="govuk-details__summary">
                                <span class="govuk-details__summary-text">
                                    Additional log message detail
                                </span>
                            </summary>
                            <div class="govuk-details__text">

                                <dl class="govuk-summary-list">
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Environment</dt>
                                        <dd class="govuk-summary-list__value">@message.Environment</dd>
                                    </div>
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">HTTP Method</dt>
                                        <dd class="govuk-summary-list__value">@message.HttpMethod</dd>
                                    </div>
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">URL</dt>
                                        <dd class="govuk-summary-list__value">
                                            <a href="@message.Url"> @message.Url</a>
                                        </dd>
                                    </div>
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Referrer URL</dt>
                                        <dd class="govuk-summary-list__value">
                                            <a href="@message.ReferrerUrl"> @message.ReferrerUrl</a>
                                        </dd>
                                    </div>
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">User Agent</dt>
                                        <dd class="govuk-summary-list__value">@message.UserAgent</dd>
                                    </div>

                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Request Body</dt>
                                        <dd class="govuk-summary-list__value">
                                            @if (!string.IsNullOrWhiteSpace(message.RequestJsonBody))
                                            {
                                                <textarea class="govuk-textarea" rows="8">@message.RequestJsonBody</textarea>
                                            }
                                        </dd>
                                    </div>
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Exception details</dt>
                                        <dd class="govuk-summary-list__value">
                                            @if (!string.IsNullOrWhiteSpace(message.Exception))
                                            {
                                                <textarea class="govuk-textarea" rows="8">@message.Exception</textarea>
                                            }
                                        </dd>
                                    </div>


                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">User ID</dt>
                                        <dd class="govuk-summary-list__value">@message.UserId</dd>
                                    </div>
                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Username</dt>
                                        <dd class="govuk-summary-list__value">@message.UserName</dd>
                                    </div>

                                    <div class="govuk-summary-list__row">
                                        <dt class="govuk-summary-list__key">Client IP Address</dt>
                                        <dd class="govuk-summary-list__value">@message.ClientIpAddress</dd>
                                    </div>

                                </dl>
                            </div>
                        </details>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>


</div>
</div>
