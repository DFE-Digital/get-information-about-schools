@model Edubase.Web.UI.Models.Admin.LogsViewModel

@{
    ViewBag.Title = "View logs";
    ViewBag.bodyClasses = "view-logs";
    ViewBag.SiteSection = "tools";

    var sortedMessages = Model.Messages
        .OrderByDescending(m => m.Timestamp)
        .ToList();
}

@section BreadCrumbs
{
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <div class="govuk-breadcrumbs">
                <ol class="govuk-breadcrumbs__list">
                    <li class="govuk-breadcrumbs__list-item">
                        @Html.ActionLink("Home", "Index", "Home", new { area = "" }, new { @class = "govuk-breadcrumbs__link" })
                    </li>
                    <li class="govuk-breadcrumbs__list-item">
                        @Html.ActionLink("Tools", "Index", "Tools", new { area = "" }, new { @class = "govuk-breadcrumbs__link" })
                    </li>
                    <li id="tertiary-breadcrumb" class="govuk-breadcrumbs__list-item hidden">
                        @Html.ActionLink("View error logs", "ViewLogs", "Admin", new { area = "" }, new { @class = "govuk-breadcrumbs__link" })
                    </li>
                </ol>
            </div>
        </div>
    </div>
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-xl">Errors</h1>

        @* <div class="govuk-inset-text"> *@
        <div>
            <p class="govuk-body">
                This page shows the most recent messages that have been logged by the C# frontend.
                The vast bulk of these are generated by the "Sorry, there is a problem with the service" page, where the user is also shown a reference ID.
            </p>
            <p class="govuk-body">
                If you need to investigate any of these further, or if you need to query the logs of any other component (e.g., the Java API), please contact the technical team.
            </p>
        </div>

        <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible govuk-!-margin-top-0"/>

        @*
            HTTP GET used deliberately here, to allow for shareable search URLs
            (useful when collaborating on investigating/fixing a problem, and for including within a bug report, for instance)
        *@
        @using (Html.BeginForm("ViewLogs", "Admin", FormMethod.Get))
        {
            <h3 class="govuk-heading-m">Search filters</h3>
            <div class="govuk-form-group">
                <fieldset class="govuk-fieldset" role="group" aria-describedby="start-date-hint">
                    <legend class="govuk-fieldset__legend">
                        Start Date (UTC)
                    </legend>
                    @Html.ValidationMessageFor(x => x.StartDate, null, new { @class = "govuk-error-message" })
                    <div class="govuk-date-input" id="start-date">
                        <div class="govuk-date-input__item">
                            @Html.TextBoxFor(x => x.StartDateDay, new { id = "start-date-day", type = "text", @class = "govuk-input govuk-date-input__input govuk-input--width-2", inputmode = "numeric" })
                        </div>
                        <div class="govuk-date-input__item">
                            @Html.TextBoxFor(x => x.StartDateMonth, new { id = "start-date-month", type = "text", @class = "govuk-input govuk-date-input__input govuk-input--width-2", inputmode = "numeric" })
                        </div>
                        <div class="govuk-date-input__item">
                            @Html.TextBoxFor(x => x.StartDateYear, new { id = "start-date-year", type = "text", @class = "govuk-input govuk-date-input__input govuk-input--width-4", inputmode = "numeric" })
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="govuk-form-group">
                <fieldset class="govuk-fieldset" role="group" aria-describedby="end-date-hint">
                    <legend class="govuk-fieldset__legend">
                        End Date (UTC)
                    </legend>
                    @Html.ValidationMessageFor(x => x.EndDate, null, new { @class = "govuk-error-message" })
                    <div class="govuk-date-input" id="end-date">
                        <div class="govuk-date-input__item">
                            @Html.TextBoxFor(x => x.EndDateDay, new { id = "end-date-day", type = "text", @class = "govuk-input govuk-date-input__input govuk-input--width-2", inputmode = "numeric" })
                        </div>
                        <div class="govuk-date-input__item">
                            @Html.TextBoxFor(x => x.EndDateMonth, new { id = "end-date-month", type = "text", @class = "govuk-input govuk-date-input__input govuk-input--width-2", inputmode = "numeric" })
                        </div>
                        <div class="govuk-date-input__item">
                            @Html.TextBoxFor(x => x.EndDateYear, new { id = "end-date-year", type = "text", @class = "govuk-input govuk-date-input__input govuk-input--width-4", inputmode = "numeric" })
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="govuk-form-group">
                <div class="govuk-checkboxes" data-module="govuk-checkboxes">
                    <div class="govuk-checkboxes__item">
                        @Html.CheckBoxFor(x => x.IncludePurgeZeroLogsMessage, new { @class = "govuk-checkboxes__input", id = "include-purge-zero-logs-message-checkbox" })
                        @Html.LabelFor(x => x.IncludePurgeZeroLogsMessage, new { @class = "govuk-label govuk-checkboxes__label" })
                        @Html.ValidationMessageFor(x => x.IncludePurgeZeroLogsMessage, null, new { @class = "govuk-error-message" })
                    </div>
                </div>
            </div>

            <div class="govuk-form-group">
                @Html.LabelFor(x => x.Query, new { @class = "govuk-label", id = "query-label" })
                @Html.ValidationMessageFor(x => x.Query, null, new { @class = "govuk-error-message" })
                @Html.TextBoxFor(x => x.Query, new { @class = "govuk-input", id = "query-input" })
            </div>

            <div class="govuk-form-group">
                <div class="govuk-button-group">
                    <button type="submit" class="govuk-button" data-module="govuk-button">
                        Search
                    </button>
                    @* reset link, which just directs to the current page without query parameters therefore using default values *@
                    <a href="@Url.Action("ViewLogs", "Admin")" class="govuk-link">Reset</a>
                </div>
            </div>
        }

        <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible govuk-!-margin-top-0"/>

        <h3 class="govuk-heading-m">Search results</h3>
        <p class="govuk-body">
            Results count: @sortedMessages.Count()
        </p>

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <table class="govuk-table govuk-table--small-text-until-tablet">
                    <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Timestamp</th>
                        <th scope="col" class="govuk-table__header">Message</th>
                        @* <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Request</th> *@

                    </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                    @foreach (var message in sortedMessages)
                    {
                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell" style="overflow: auto;">@message.Timestamp</td>
                            <td class="govuk-table__cell" style="max-width: 7.5em; overflow: auto;">
                                <div class="govuk-inset-text">
                                    Reference: <strong class="govuk-tag govuk-tag--grey">@message.Id</strong>
                                    <br/>
                                    <a href="@message.Url">@message.Url</a>
                                </div>
                                @* <br/> *@
                                @* <br/> *@
                                @message.Message
                                <br/>
                                <br/>
                                <details class="govuk-details">
                                    <summary class="govuk-details__summary">
                                        <span class="govuk-details__summary-text">
                                            Additional log message detail
                                        </span>
                                    </summary>
                                    <div class="govuk-details__text">

                                        <dl class="govuk-summary-list">
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">Environment</dt>
                                                <dd class="govuk-summary-list__value">@message.Environment</dd>
                                            </div>
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">HTTP Method</dt>
                                                <dd class="govuk-summary-list__value">@message.HttpMethod</dd>
                                            </div>
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">URL</dt>
                                                <dd class="govuk-summary-list__value">
                                                    <a href="@message.Url"> @message.Url</a>
                                                </dd>
                                            </div>
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">Referrer URL</dt>
                                                <dd class="govuk-summary-list__value">
                                                    <a href="@message.ReferrerUrl"> @message.ReferrerUrl</a>
                                                </dd>
                                            </div>
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">User Agent</dt>
                                                <dd class="govuk-summary-list__value">@message.UserAgent</dd>
                                            </div>

                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">Request Body</dt>
                                                <dd class="govuk-summary-list__value">
                                                    @if (!string.IsNullOrWhiteSpace(message.RequestJsonBody))
                                                    {
                                                        <textarea class="govuk-textarea" rows="8">@message.RequestJsonBody</textarea>
                                                    }
                                                </dd>
                                            </div>
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">Exception details</dt>
                                                <dd class="govuk-summary-list__value">
                                                    @if (!string.IsNullOrWhiteSpace(message.Exception))
                                                    {
                                                        <textarea class="govuk-textarea" rows="8">@message.Exception</textarea>
                                                    }
                                                </dd>
                                            </div>


                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">User ID</dt>
                                                <dd class="govuk-summary-list__value">@message.UserId</dd>
                                            </div>
                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">Username</dt>
                                                <dd class="govuk-summary-list__value">@message.UserName</dd>
                                            </div>

                                            <div class="govuk-summary-list__row">
                                                <dt class="govuk-summary-list__key">Client IP Address</dt>
                                                <dd class="govuk-summary-list__value">@message.ClientIpAddress</dd>
                                            </div>

                                        </dl>
                                    </div>
                                </details>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
