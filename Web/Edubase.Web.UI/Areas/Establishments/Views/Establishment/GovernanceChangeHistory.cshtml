@using Edubase.Services.Domain
@using Edubase.Web.UI.Helpers
@using Edubase.Web.UI.Models
@using Edubase.Common
@model EstablishmentDetailViewModel
@{
    ViewBag.Title = Model.Establishment.Name;
    ViewBag.PageClass = "school-details";
    ViewBag.HideLogo = true;

    var request = HttpContext.Current.Request;
    var sortDir = "desc";
    var sortField = "effectiveDateUtc";
    if (request.QueryString["sortby"] != null)
    {
        sortField = request.QueryString["sortby"].Substring(0, request.QueryString["sortby"].IndexOf("-"));
        sortDir = (request.QueryString["sortby"] ?? "").Contains("asc") ? "asc" : "desc";
    }

}

<div class="breadcrumbs">
    <ul>
        <li>@Html.ActionLink("Home", "Index", "Search", new { area = "" }, null)</li>
        @if (Model.LegalParentGroup != null)
        {
            <li>@Html.RouteLink(Model.LegalParentGroupRouteDto.Value.Label, Model.LegalParentGroupRouteDto.Value.RouteName, Model.LegalParentGroupRouteDto.Value.RouteValues)</li>
        }
        <li>@Html.RouteLink(Model.Establishment.Name, "EstabDetails", new { id = Model.Establishment.Urn })</li>
    </ul>
</div>

<h1 class="heading-large">@(Model.Establishment.Name.Clean() ?? "(name not recorded)")</h1>

<p class="urn"><abbr title="Unique Reference Number">URN</abbr>: @Model.Establishment.Urn</p>
<p class="establishment-type">@Model.TypeName</p>

<div class="column-full">
    <div class="grid-row horizontal-tabs-wrapper">
        <div class="tab-wrap">
            <ul class="horizontal-tabs">
                <li><a href="#school-change-history" class="horizontal-tab">Governance Change History</a></li>
            </ul>
        </div>
        <div class="tab-content-wrapper horizontal-tabs-content">

            <div id="change-history" class="tab-content approval-data">
                <h2 class="bold-small">Governance Change History</h2>
                @if (!Model.ChangeHistory.Items.Any())
                {
                    <p>There are no change records available at the moment</p>
                }
                else
                {
                    <p>
                        @Html.RouteLink("Download data in CSV format", "DownloadEstablishmentGovernanceChangeHistory", new { id = Model.Establishment.Urn, downloadType = DownloadType.csv }, new { style = "margin-bottom:10px; display:block;" })
                        @Html.RouteLink("Download data in XLSX format", "DownloadEstablishmentGovernanceChangeHistory", new { id = Model.Establishment.Urn, downloadType = DownloadType.xlsx }, null)
                        <br />
                    </p>
                    if (Model.ChangeHistory.PageCount > 1)
                    {
                        <div class="top-pagination">
                            @Html.Partial("_GenericPaginationV2", Model.ChangeHistory)
                        </div>
                    }
                    <table class="approval-changes edubase-table sortable-table">
                        <caption class="visuallyhidden">Governance change history</caption>
                        <thead>
                            <tr>
                                <th scope="col">
                                    <a href="@Url.SortUrl("effectiveDateUtc", "#change-history")"
                                       class="@Html.Conditional(sortField == "effectiveDateUtc", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">Date changed</a>
                                </th>
                                <th scope="col">
                                    <a href="@Url.SortUrl("fieldName", "#change-history")"
                                       class="@Html.Conditional(sortField == "fieldName", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">Updated field</a>
                                </th>
                                <th scope="col">
                                    <a href="@Url.SortUrl("oldValue", "#change-history")"
                                       class="@Html.Conditional(sortField == "oldValue", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">Old value</a>
                                </th>
                                <th scope="col">
                                    <a href="@Url.SortUrl("newValue", "#change-history")"
                                       class="@Html.Conditional(sortField == "newValue", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">New value</a>
                                </th>
                                <th scope="col">
                                    <a href="@Url.SortUrl("requestedDateUtc", "#change-history")"
                                       class="@Html.Conditional(sortField == "requestedDateUtc", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">Date requested</a>
                                </th>
                                <th scope="col">
                                    <a href="@Url.SortUrl("originatorUserName", "#change-history")"
                                       class="@Html.Conditional(sortField == "originatorUserName", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">Suggested from</a>
                                </th>
                                <th scope="col">
                                    <a href="@Url.SortUrl("approverUserName", "#change-history")"
                                       class="@Html.Conditional(sortField == "approverUserName", "selected-sort") @(sortDir == "asc"? "sorted-asc": "sorted-desc")">Approved by</a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ChangeHistory.Items)
                            {
                                <tr>
                                    <td data-label="Date changed">@(item.EffectiveDateUtc?.ToString("dd/MM/yyyy"))</td>
                                    <td data-label="Updated field">@item.Name</td>
                                    <td data-label="Old value">@item.OldValue</td>
                                    <td data-label="New value">@item.NewValue</td>
                                    <td data-label="Date requested">@(item.RequestedDateUtc?.ToString("dd/MM/yyyy"))</td>
                                    <td data-label="Suggested from">@item.OriginatorUserName</td>
                                    <td data-label="Approved by">@(item.ApproverUserName ?? "--")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    if (Model.ChangeHistory.PageCount > 1)
                    {
                        <div class="lower-pagination">
                            @Html.Partial("_GenericPaginationV2", Model.ChangeHistory)
                        </div>
                    }

                }
            </div>
        </div>
    </div>
</div>

